## Install packages and load libraries
install.packages(c(
  "dplyr", "ggplot", "ggcorrplot"
))

library(dplyr)
library(ggplot)
library(ggcorrplot)

## Check correlation among traits
traits.correlation <- read.csv("traits.official.csv", sep = ";", check.names = FALSE) %>%
  dplyr::select(species, max.body.size, fecundity, trophic.level) %>%
  mutate(log_fecundity = log(fecundity)) %>%
  dplyr::select(-fecundity) 

Tr.fish.cor <- Tr.fish.cor %>%
  dplyr::select(-species)

is.numeric(Tr.fish.cor)
Tr.fish.cor <- na.omit(Tr.fish.cor)
head(Tr.fish.cor)

# See if traits are normally distributed
# If yes, use Pearson - if no, use Spearman
# Fecundity
    hist(Tr.fish.cor$log_fecundity)
# Max length
    hist(Tr.fish.cor$max.body.size)
# Trophic level
    hist(Tr.fish.cor$trophic.level)
       
# Map out correlations
traits.cor.pearson <- cor(Tr.fish.cor, method = "pearson", use = "complete.obs")
traits.cor.pearson.plot <- ggcorrplot(traits.cor.pearson, show.diag = T, hc.order = F, type = "lower", legend.title = "Correlation",
              outline.color = "lightgrey", lab = TRUE, digits = 2) +
              scale_fill_stepsn(name = "Correlation", breaks = c(-1, -0.7, 0.7, 1), limits = c(-1, 1), show.limits = T,
                         colours = c('blue','white','red'))
traits.cor.pearson.plot

tiff("traits.cor.spearman.tiff", width=8, height=6, units="cm", res=300)
traits.cor.spearman <- cor(Tr.fish.cor, method = "spearman", use = "complete.obs")
traits.cor.spearman.plot <- ggcorrplot(traits.cor.spearman, 
                                               show.diag = T, 
                                               hc.order = F, 
                                               type = "lower", 
                                               legend.title = "Correlation",
                                               outline.color = "lightgrey", 
                                               lab = TRUE,
                                               digits = 2,
                                               lab_size = 2.5) +
          scale_fill_stepsn(name = "Correlation", 
                            breaks = c(-1, -0.7, 0.7, 1), 
                            limits = c(-1, 1), 
                            show.limits = T,
                            colours = c('blue','white','red')) +
          theme(axis.text.x = element_text(size = 8, angle = 45, hjust = 1), 
                axis.text.y = element_text(size = 8), 
                axis.title = element_text(size = 8), 
                legend.title = element_text(size = 8), 
                legend.text = element_text(size = 8), 
                legend.key.size = unit(0.4, "cm"))      
traits.cor.spearman.plot
ggsave("traits.cor.spearman.plot.tiff", plot=traits.cor.spearman.plot, device="tiff", width=15, height=9, units="cm", dpi=300)


## Check correlation among env covariates
    # Prep data for correlation analysis
        load("HMSC_occurrence_1n")
        env.cor <- environment
        env.cor$ice_days <- as.numeric(env.cor$ice_days)

    # See if env variables are normally distributed
        # If yes, use Pearson
        # If no, use Spearman

    # SST
        hist(env.cor$SST)
            # Normal-ish
    # SBT
        hist(env.cor$SBT)
            # Normal-ish
    # SSS
        hist(env.cor$SSS)
            # Not normal
        hist(log(env.cor$SSS))
            # Not normal
    # SBS
        hist(env.cor$SBS)
            # Normal-ish
    # Depth
        hist(env.cor$log_depth)
            # Normal-ish
    # Sea Ice Concentration
        hist(env.cor$ice_days)
            # Not normal
        hist(log(env.cor$ice_days))
            # Normal-ish
    # Mixed Layer Depth
        hist(env.cor$mixed_layer)
            # Normal-ish
    # SST Seasonality
        hist(env.cor$SST_seasonality)
            # Normal-ish
    # SBT Seasonality
        hist(env.cor$SBT_seasonality)
            # Not normal
        hist(log(env.cor$SBT_seasonality))
            # Normal-ish
    # SSS Seasonality
        hist(env.cor$SSS_seasonality)
            # Not normal
        hist(log(env.cor$SSS_seasonality))
            # Normal-ish
    # SBS Seasonality
        hist(env.cor$SBS_seasonality)
            # Not normal
        hist(log(env.cor$SBS_seasonality))
            # Normal-ish

# Calculate correlation coefficients
env.cor.pearson <- cor(env.cor, method = "pearson", use = "complete.obs")
# Plot correlation coefficients
tiff("env.cor.pearson.tiff", width=20, height=14, units="cm", res=300)
env.cor.pearson <- cor(env.cor, method = "pearson", use = "complete.obs")
env.cor.pearson.plot <- ggcorrplot(env.cor.pearson, 
                                           show.diag = T, 
                                           hc.order = F, 
                                           type = "lower", 
                                           legend.title = "Correlation",
                                           outline.color = "lightgrey", 
                                           lab = TRUE,
                                           digits = 2,
                                           lab_size = 2.5) +
          scale_fill_stepsn(name = "Correlation", 
                            breaks = c(-1, -0.8, 0.8, 1), 
                            limits = c(-1, 1), 
                            show.limits = T,
                            colours = c('blue','white','red')) +
          theme(axis.text.x = element_text(size = 8, angle = 45, hjust = 1), 
                axis.text.y = element_text(size = 8), 
                axis.title = element_text(size = 8), 
                legend.title = element_text(size = 8), 
                legend.text = element_text(size = 8), 
                legend.key.size = unit(0.4, "cm"))      
        par(mar = c(0, 0, 0, 0))
env.cor.pearson.plot
ggsave("env.cor.pearson.plot.tiff", plot=env.cor.pearson.plot, device="tiff", width=15, height=9, units="cm", dpi=300)

# End script "03 Test for correlation among traits and environmental covariates"
